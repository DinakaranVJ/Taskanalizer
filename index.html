<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Task Analyzer Dashboard</title>
<!-- Load vis-network properly -->
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* Global */
body {
    font-family: "Inter", Arial, sans-serif;
    padding: 20px;
    background: linear-gradient(to bottom right, #eef2f3, #dfe9f3);
    margin: 0;
}

/* Title */
h1 {
    text-align: center;
    color: #1f2937;
    margin-bottom: 25px;
    font-size: 2.2rem;
    font-weight: 700;
    letter-spacing: -0.5px;
}

/* Card container */
.container {
    margin-bottom: 30px;
    background: #ffffff;
    padding: 22px;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.10);
}

/* Headers inside containers */
.container h2, .container h3 {
    margin-top: 0;
    margin-bottom: 18px;
    color: #111827;
    font-size: 1.4rem;
    font-weight: 600;
}

/* Form Layout */
.row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
}

label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #374151;
}

input, select, textarea {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
    background: #f8fafc;
    width: 100%;
    box-sizing: border-box;
    font-size: 0.95rem;
    transition: 0.2s;
}

input:focus, select:focus, textarea:focus {
    background: #fff;
    border-color: #3b82f6;
    outline: none;
    box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
}

textarea.bulk {
    width: 100%;
    min-height: 100px;
    resize: vertical;
}

/* Buttons */
button {
    margin-top: 12px;
    padding: 10px 18px;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95rem;
    transition: background 0.2s ease, transform 0.15s ease;
}

button:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
}

button:active {
    transform: translateY(1px);
}

button[style*="background:#6c757d"] {
    background: #6b7280 !important;
}

button[style*="background:#6c757d"]:hover {
    background: #4b5563 !important;
}

/* Task List Box */
.task-list {
    list-style: none;
    padding: 0;
    margin-top: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #f9fafb;
    min-height: 70px;
}

.task-list li {
    padding: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    cursor: grab;
    transition: background 0.2s ease;
}

.task-list li:hover {
    background: #f3f4f6;
}

.task-list li:last-child {
    border-bottom: none;
}

/* Badges */
.badge {
    padding: 5px 9px;
    border-radius: 10px;
    color: white;
    font-weight: 700;
    font-size: 12px;
}

.importance-1-3 { background:#ef4444; }
.importance-4-7 { background:#f59e0b; color:#111; }
.importance-8-10 { background:#22c55e; }

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
    border-radius: 10px;
    overflow: hidden;
}

th {
    background: #2563eb;
    color: white;
    padding: 12px;
    font-weight: 600;
}

td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    background: #ffffff;
}

tr:hover td {
    background: #f3f4f6;
}

/* Score Styling */
.score-high, .score-medium, .score-low {
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 700;
    display: inline-block;
}

.score-high { background:#22c55e; color:white; }
.score-medium { background:#facc15; color:#111; }
.score-low { background:#ef4444; color:white; }

/* Responsive */
@media (max-width:720px){
    .row {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
    }
}

    </style>
</head>
<body>
    <h1>Task Analyzer Dashboard</h1>

    <div class="container">
        <h2>Manage Tasks</h2>

        <div class="row">
            <div style="flex:1; min-width:220px">
                <label>Title</label>
                <input id="taskTitle" placeholder="Task title" />
            </div>

            <div>
                <label>Estimated Hours</label>
                <input id="taskHours" type="number" step="0.1" placeholder="e.g. 2.5" />
            </div>

            <div>
                <label>Importance (1-10)</label>
                <input id="taskImportance" type="number" min="1" max="10" placeholder="7" />
            </div>
        </div>

        <div class="row">
            <div style="flex:1; min-width:220px">
                <label>Due Date (optional)</label>
                <input id="taskDueDate" type="date" />
            </div>

            <div style="flex:1; min-width:220px">
                <label>Dependencies (optional, comma-separated IDs)</label>
                <input id="taskDependencies" placeholder="e.g. 1,2" />
            </div>

            <div style="min-width:200px">
                <label>Strategy</label>
                <select id="strategySelect">
                    <option value="smart_balance">Smart Balance (default)</option>
                    <option value="fastest">Fastest Wins</option>
                    <option value="high_impact">High Impact</option>
                    <option value="deadline">Deadline Driven</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <button onclick="addTask()">Add Task</button>
            <button onclick="resetTasks()" style="background:#6c757d">Reset Tasks</button>
            <div style="flex:1"></div>
            <div style="width:360px">
                <label>Bulk JSON input (paste JSON array here)</label>
                <textarea id="bulkInput" class="bulk" placeholder='[{"title":"Fix bug","estimated_hours":2,"importance":7, "due_date":"2025-12-01", "dependencies":[1]}]'></textarea>
                <div style="margin-top:8px;">
                    <button onclick="pasteBulk()">Use Bulk JSON</button>
                </div>
            </div>
        </div>

        <ul id="taskList" class="task-list"></ul>
    </div>

    <div class="container">
        <h3>Analyze Results</h3>
        <table id="analyzeTable" style="display:none">
            <thead>
                <tr>
                    <th>Title</th><th>Hours</th><th>Importance</th><th>Due Date</th><th>Dependencies</th><th>Score</th><th>Explanation</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="container">
        <h3>Top 3 Suggestions</h3>
        <table id="suggestTable" style="display:none">
            <thead>
                <tr>
                    <th>Title</th><th>Hours</th><th>Importance</th><th>Due Date</th><th>Dependencies</th><th>Score</th><th>Why</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="container">
    <h3>Dependency Graph</h3>
    <div id="graph" style="width:100%; height:400px; background:white; border:1px solid #ddd; border-radius:10px;"></div>
    </div>


<script>
/* Frontend logic:
   - Auto-assign incremental IDs (so dependencies refer to IDs)
   - Drag/drop reorder
   - strategy select included as ?strategy=...
   - Live update on change
*/
let tasks = [];
let nextId = 1;

function addTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const hours = parseFloat(document.getElementById('taskHours').value);
    const importance = parseInt(document.getElementById('taskImportance').value);
    const due_date = document.getElementById('taskDueDate').value || null;
    const depsRaw = document.getElementById('taskDependencies').value.trim();
    const dependencies = depsRaw ? depsRaw.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n)) : [];

    if (!title || isNaN(hours) || isNaN(importance) || importance < 1 || importance > 10 || hours <= 0) {
        alert("Please provide valid Title, Estimated Hours (>0) and Importance (1-10).");
        return;
    }

    const task = { id: nextId++, title, estimated_hours: hours, importance, due_date, dependencies };
    tasks.push(task);
    renderTaskList();
    clearInputs();
    updateTables();
}

function clearInputs(){
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskHours').value = '';
    document.getElementById('taskImportance').value = '';
    document.getElementById('taskDueDate').value = '';
    document.getElementById('taskDependencies').value = '';
}

function renderTaskList(){
    const ul = document.getElementById('taskList');
    ul.innerHTML = '';
    tasks.forEach((t, idx) => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.index = idx;

        const importanceClass = t.importance <=3 ? 'importance-1-3' : (t.importance<=7 ? 'importance-4-7' : 'importance-8-10');

        li.innerHTML = `<div><strong>${t.title}</strong> <div style="font-size:12px;color:#555">ID:${t.id} • Hours:${t.estimated_hours} • Due:${t.due_date || '-'}</div></div>
                        <div><span class="badge ${importanceClass}">Imp:${t.importance}</span></div>`;

        li.addEventListener('dragstart', dragStart);
        li.addEventListener('dragover', dragOver);
        li.addEventListener('drop', drop);
        ul.appendChild(li);
    });
}

let draggedIndex = null;
function dragStart(e){ draggedIndex = e.target.dataset.index; }
function dragOver(e){ e.preventDefault(); }
function drop(e){
    const targetIndex = e.target.closest('li')?.dataset.index;
    if (draggedIndex === null || targetIndex === undefined) return;
    const a = tasks.splice(draggedIndex,1)[0];
    tasks.splice(targetIndex,0,a);
    draggedIndex = null;
    renderTaskList();
    updateTables();
}

async function updateTables(){
    if (tasks.length === 0) {
        document.getElementById('analyzeTable').style.display='none';
        document.getElementById('suggestTable').style.display='none';
        return;
    }

    const strategy = document.getElementById('strategySelect').value || 'smart_balance';
    try {
        // Analyze (POST)
        const analyzeRes = await fetch(`/api/tasks/analyze/?strategy=${encodeURIComponent(strategy)}`, {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(tasks)
        });
        const analyzeData = await analyzeRes.json();
        populateAnalyzeTable(analyzeData);
        renderDependencyGraph(analyzeData);


        // Suggest (GET)
        const suggestRes = await fetch(`/api/tasks/suggest/?strategy=${encodeURIComponent(strategy)}&tasks=${encodeURIComponent(JSON.stringify(tasks))}`);
        const suggestData = await suggestRes.json();
        populateSuggestTable(suggestData);
    } catch (err) {
        console.error(err);
    }
}

function populateAnalyzeTable(data){
    const table = document.getElementById('analyzeTable');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    data.forEach(task => {
        const tr = document.createElement('tr');
        const scoreClass = task.score >= 8 ? 'score-high' : (task.score >=5 ? 'score-medium' : 'score-low');
        tr.innerHTML = `
            <td>${task.title || '-'}</td>
            <td>${task.estimated_hours ?? '-'}</td>
            <td><span class="badge ${task.importance <=3 ? 'importance-1-3' : task.importance <=7 ? 'importance-4-7' : 'importance-8-10'}">${task.importance ?? '-'}</span></td>
            <td>${task.due_date ?? '-'}</td>
            <td>${(task.dependencies && task.dependencies.length) ? task.dependencies.join(',') : '-'}</td>
            <td><span class="${scoreClass}">${(task.score!==undefined)?(task.score.toFixed(2)): '-'}</span></td>
            <td>${task.explanation ?? '-'}</td>
        `;
        tbody.appendChild(tr);
    });
    table.style.display = data.length>0 ? 'table' : 'none';
}

function populateSuggestTable(data){
    const table = document.getElementById('suggestTable');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    data.forEach(task => {
        const tr = document.createElement('tr');
        const scoreClass = task.score >= 8 ? 'score-high' : (task.score >=5 ? 'score-medium' : 'score-low');
        tr.innerHTML = `
            <td>${task.title || '-'}</td>
            <td>${task.estimated_hours ?? '-'}</td>
            <td><span class="badge ${task.importance <=3 ? 'importance-1-3' : task.importance <=7 ? 'importance-4-7' : 'importance-8-10'}">${task.importance ?? '-'}</span></td>
            <td>${task.due_date ?? '-'}</td>
            <td>${(task.dependencies && task.dependencies.length) ? task.dependencies.join(',') : '-'}</td>
            <td><span class="${scoreClass}">${(task.score!==undefined)?(task.score.toFixed(2)): '-'}</span></td>
            <td>${task.explanation ?? '-'}</td>
        `;
        tbody.appendChild(tr);
    });
    table.style.display = data.length>0 ? 'table' : 'none';
}

function pasteBulk(){
    const txt = document.getElementById('bulkInput').value.trim();
    if (!txt) { alert('Paste JSON array into bulk input first.'); return; }
    try {
        const arr = JSON.parse(txt);
        if (!Array.isArray(arr)) throw new Error('Not an array');
        // assign ids to any incoming tasks and push
        arr.forEach(obj => {
            // validate minimal fields
            if (!obj.title || typeof obj.estimated_hours === 'undefined' || typeof obj.importance === 'undefined') {
                // skip or alert?
                console.warn('Skipping invalid item', obj);
                return;
            }
            const deps = Array.isArray(obj.dependencies) ? obj.dependencies.map(n=>parseInt(n)).filter(n=>!isNaN(n)) : [];
            const t = {
                id: obj.id ?? nextId++,
                title: obj.title,
                estimated_hours: parseFloat(obj.estimated_hours),
                importance: parseInt(obj.importance),
                due_date: obj.due_date || null,
                dependencies: deps
            };
            tasks.push(t);
        });
        renderTaskList();
        updateTables();
    } catch(e){
        alert('Invalid JSON: ' + e.message);
    }
}

function resetTasks(){
    if (!confirm('Reset all tasks?')) return;
    tasks = [];
    nextId = 1;
    renderTaskList();
    updateTables();
}

// watch for strategy change
document.getElementById('strategySelect').addEventListener('change', updateTables);

function renderDependencyGraph(data) {
    const nodes = [];
    const edges = [];

    data.forEach(task => {
        nodes.push({
            id: task.id,
            label: `${task.title}\n(ID: ${task.id})`,
            color: task.in_cycle ? "#ef4444" : "#3b82f6",
            font: { color: "white" },
            shape: "box",
            margin: 10
        });

        task.dependencies.forEach(dep => {
            edges.push({
                from: dep,
                to: task.id,
                arrows: "to"
            });
        });
    });

    const container = document.getElementById("graph");
    const networkData = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges)
    };

    const options = {
        layout: { hierarchical: false },
        edges: { color: "#6b7280" },
        nodes: { borderWidth: 1 },
        physics: { enabled: true }
    };

    new vis.Network(container, networkData, options);
}

</script>
</body>
</html>
